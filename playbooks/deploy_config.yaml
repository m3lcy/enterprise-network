- name: Render and deploy device configs
  hosts: routers,l3_switches,access_switches
  gather_facts: no
  connection: network_cli
  vars_files:
    - ../data/globals.yaml

  vars:
    output_dir: "{{ playbook_dir }}/../outputs/{{ inventory_hostname }}"
    log_dir: "{{ playbook_dir }}/../logs"
    log_file: "{{ log_dir }}/{{ inventory_hostname }}.log"
    deploy_mode: "{{ mode | default('dry-run') }}"

  pre_tasks:
    - name: Load host-specific variables
      ansible.builtin.include_vars:
        file: "../data/{{ inventory_hostname }}.yaml"
      register: host_vars
      ignore_errors: yes

    - name: Ensure output directory exists
      ansible.builtin.file:
        path: "{{ output_dir }}"
        state: directory
        mode: '0755'

    - name: Ensure logs directory exists
      ansible.builtin.file:
        path: "{{ log_dir }}"
        state: directory
        mode: '0755'

    - name: Validate mode
      ansible.builtin.fail:
        msg: "Invalid mode '{{ deploy_mode }}'. Must be 'dry-run' or 'commit'."
      when: deploy_mode not in ['dry-run', 'commit']

  tasks:
    - block:

        - name: Set path variables and timestamp
          ansible.builtin.set_fact:
            timestamp: "{{ lookup('pipe', 'date +%Y%m%d_%H%M%S') }}"
            current_config_path: "{{ output_dir }}/config_{{ lookup('pipe', 'date +%Y%m%d_%H%M%S') }}.cfg"

        - name: Render config template to file
          ansible.builtin.template:
            src:  "{{ playbook_dir }}/../templates/call_templates.j2"
            dest: "{{ current_config_path }}"
            backup: yes
          register: rendered_result
          check_mode: no

        - name: Debug rendered file
          ansible.builtin.stat:
            path: "{{ output_dir }}/config_{{ timestamp }}.cfg"
          register: rendered_file

        - name: Log render success
          ansible.builtin.lineinfile:
            path: "{{ log_file }}"
            line: "[{{ timestamp }}] Rendered config for {{ inventory_hostname }}"
            create: true
            insertafter: EOF

        - name: Preview or Push config to device
          cisco.ios.ios_config:
            src: "{{ current_config_path }}"
            backup: yes
            diff_against: running
            save_when: "{{ 'modified' if deploy_mode == 'commit' else 'never' }}"
          check_mode: "{{ true if deploy_mode == 'dry-run' else false }}"
          register: push_result

        - name: Display diff for review 
          ansible.builtin.debug:
            msg: "{{ push_result.diff | default('No differences detected') }}"
          when: deploy_mode == 'dry-run'

        - name: Log Push/Preview result
          ansible.builtin.lineinfile:
            path: "{{ log_file }}"
            line: "[{{ timestamp }}] {{ 'Previewed (dry-run)' if deploy_mode == 'dry-run' else 'Pushed and Committed' }} config to {{ inventory_hostname }}"
            create: true
            insertafter: EOF

      rescue:
        - name: Log failure
          ansible.builtin.lineinfile:
            path: "{{ log_file }}"
            line: >-
              [{{ timestamp }}] Failed to render or {{ 'preview' if deploy_mode == 'dry-run' else 'push/commit' }} config for {{ inventory_hostname }}:
              {{ render_result.msg | default('Render not attempted') }},
              {{ push_result.msg | default('Push not attempted') }}
            create: true
            insertafter: EOF

      always:
        - name: Log task completion
          ansible.builtin.lineinfile:
            path: "{{ log_file }}"
            line: "[{{ timestamp }}] Task finished for {{ inventory_hostname }} (mode: {{ deploy_mode }})"
            create: true
            insertafter: EOF